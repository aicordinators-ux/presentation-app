<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…ØµÙ…Ù… Ø¨Ø±Ø²Ù†ØªÙŠØ´Ù† â€” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
  <style>
    body { font-family: "Cairo", sans-serif; background: #f7f7f7; text-align: center; padding: 20px; }
    h2 { color: #222; margin-bottom: 20px; }
    input, textarea {
      width: 90%; padding: 8px; margin: 5px; border-radius: 6px; border: 1px solid #ccc; text-align: center;
    }
    button {
      padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; margin: 10px;
    }
    #addSlide, #exportButton { background: #007bff; color: white; }
    .image-box {
      display: inline-block; width: 250px; height: 150px; border: 2px dashed #ccc;
      border-radius: 12px; margin: 10px; vertical-align: top; background: #eef3ff; overflow: hidden;
      cursor: pointer; color: #555; line-height: 150px;
    }
    .image-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; }
  </style>
</head>
<body>

  <h2>Ù…ØµÙ…Ù… Ø¨Ø±Ø²Ù†ØªÙŠØ´Ù† â€” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>

  <button id="addSlide">â• Ø¥Ø¶Ø§ÙØ© Ø³Ù„Ø§ÙŠØ¯</button>
  <button id="exportButton">ğŸ§¾ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶</button>

  <div>
    <label>Merch Code</label><br>
    <input type="text" id="merchCode" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯">
  </div>
  <div>
    <label>Acc-Code</label><br>
    <input type="text" id="accCode" readonly>
  </div>
  <div>
    <label>Customer Name</label><br>
    <input type="text" id="customerName" readonly>
  </div>
  <div>
    <label>Address</label><br>
    <input type="text" id="address" readonly>
  </div>
  <div>
    <label>Customer Type</label><br>
    <input type="text" id="customerType" readonly>
  </div>
  <div>
    <label>Gov.</label><br>
    <input type="text" id="gov" readonly>
  </div>
  <div>
    <label>Notes</label><br>
    <textarea id="notes" rows="2"></textarea>
  </div>

  <div id="imageContainer">
    <div class="image-box"><span>Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©</span></div>
    <div class="image-box"><span>Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©</span></div>
    <div class="image-box"><span>Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©</span></div>
  </div>

  <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø±Ø¨Ø¹ Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø§Ù„Ù…Ø¹Ø±Ø¶.</p>

  <hr>
  <p>Google Sheet Ø¨ÙŠØ§Ù†Ø§Øª</p>

  <!-- ğŸ”¹ Ø±Ø¨Ø· Google Sheets -->
  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/1N6b3EQdXS4X8fMtHZ04tHkwKTOgNzQyuLVA-V7HZzOk/gviz/tq?tqx=out:json";

    document.getElementById("merchCode").addEventListener("change", async () => {
      const code = document.getElementById("merchCode").value.trim();
      if (!code) return;

      try {
        const res = await fetch(sheetURL);
        const text = await res.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
        const rows = json.table.rows;

        let found = false;
        for (let r of rows) {
          if (r.c[0] && r.c[0].v == code) {
            found = true;
            document.getElementById("accCode").value = r.c[1]?.v || "";
            document.getElementById("customerName").value = r.c[2]?.v || "";
            document.getElementById("address").value = r.c[3]?.v || "";
            document.getElementById("customerType").value = r.c[4]?.v || "";
            document.getElementById("gov").value = r.c[5]?.v || "";
            break;
          }
        }

        if (!found) alert("Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø´ÙŠØª.");
        saveData();
      } catch (e) {
        console.error(e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø´ÙŠØª.");
      }
    });
  </script>

  <!-- ğŸ”¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ± (ÙƒØ§Ù…ÙŠØ±Ø§ + Ù…Ø¹Ø±Ø¶) -->
  <script>
    document.querySelectorAll(".image-box").forEach((box) => {
      box.addEventListener("click", () => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.removeAttribute("capture"); // âœ… ÙŠØ¶Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø¹Ø±Ø¶ Ù…Ø¹Ù‹Ø§

        input.onchange = e => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = ev => {
            box.innerHTML = `<img src="${ev.target.result}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„">`;
            saveData();
          };
          reader.readAsDataURL(file);
        };
        input.click();
      });
    });
  </script>

  <!-- ğŸ”¹ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ -->
  <script>
    const fields = ["merchCode", "accCode", "customerName", "address", "customerType", "gov", "notes"];

    function saveData() {
      const data = {};
      fields.forEach(id => data[id] = document.getElementById(id).value);
      const images = [];
      document.querySelectorAll(".image-box img").forEach(img => images.push(img.src));
      data.images = images;
      localStorage.setItem("presentationData", JSON.stringify(data));
    }

    function loadData() {
      const saved = localStorage.getItem("presentationData");
      if (!saved) return;
      const data = JSON.parse(saved);
      fields.forEach(id => {
        if (data[id]) document.getElementById(id).value = data[id];
      });
      const boxes = document.querySelectorAll(".image-box");
      if (data.images) {
        data.images.forEach((src, i) => {
          if (boxes[i]) boxes[i].innerHTML = `<img src="${src}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„">`;
        });
      }
    }

    window.addEventListener("load", loadData);
    fields.forEach(id => document.getElementById(id).addEventListener("input", saveData));
  </script>

  <!-- ğŸ”¹ Ù…ÙƒØªØ¨Ø© PowerPoint -->
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.9.0/dist/pptxgen.min.js"></script>

  <!-- ğŸ”¹ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ -->
  <script>
    document.getElementById("exportButton").addEventListener("click", async function () {
      try {
        const merchCode = document.getElementById("merchCode").value || "";
        const accCode = document.getElementById("accCode").value || "";
        const customerName = document.getElementById("customerName").value || "";
        const address = document.getElementById("address").value || "";
        const customerType = document.getElementById("customerType").value || "";
        const gov = document.getElementById("gov").value || "";
        const notes = document.getElementById("notes").value || "";

        if (!merchCode && !customerName) {
          alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±.");
          return;
        }

        const pptx = new PptxGenJS();
        pptx.layout = "16x9";

        // ğŸ”¸ Ø³Ù„Ø§ÙŠØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const slide = pptx.addSlide();
        slide.addText("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„", { x: 1, y: 0.4, fontSize: 28, bold: true, color: "003366" });

        const info = [
          `Merch Code: ${merchCode}`,
          `Acc-Code: ${accCode}`,
          `Customer Name: ${customerName}`,
          `Address: ${address}`,
          `Customer Type: ${customerType}`,
          `Gov: ${gov}`,
          `Notes: ${notes}`
        ];

        let y = 1.2;
        info.forEach(line => {
          slide.addText(line, { x: 1, y, fontSize: 16, color: "000000" });
          y += 0.5;
        });

        // ğŸ”¸ Ø³Ù„Ø§ÙŠØ¯Ø§Øª Ø§Ù„ØµÙˆØ±
        const boxes = document.querySelectorAll(".image-box img");
        boxes.forEach((img, i) => {
          if (img.src) {
            const s = pptx.addSlide();
            s.addImage({ data: img.src, x: 0.5, y: 0.5, w: 8.5, h: 5 });
            s.addText(`ØµÙˆØ±Ø© ${i + 1}`, { x: 4, y: 6, fontSize: 16, color: "444" });
          }
        });

        await pptx.writeFile({ fileName: `presentation_${merchCode || "client"}.pptx` });
        alert("âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­!");
      } catch (err) {
        console.error(err);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶.");
      }
    });
  </script>

</body>
</html>
