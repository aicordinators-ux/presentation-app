<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>مصمم عروض تقديمية - بيانات العملاء</title>

<script src="https://unpkg.com/pptxgenjs@3.9.0/dist/pptxgen.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
/* ====== نفس الستايل بدون أي تعديل ====== */
body{font-family:Segoe UI,Tahoma}
.placeholder{cursor:pointer}
</style>
</head>

<body>

<input type="file" id="hiddenFileInput" accept="image/*" style="display:none">
<input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display:none">

<div id="placeholders"></div>
<div id="slidesList"></div>

<input id="merchCode">
<input id="accCode">
<input id="custName">
<input id="custAddress">
<input id="custType">
<input id="custGov">
<input id="notes">

<script>
/* ================== DATA ================== */
let excelData = [];
let slides = [{
    images: [null, null, null],
    customerData: {
        merchCode: '',
        accCode: '',
        custName: '',
        custAddress: '',
        custType: '',
        custGov: '',
        notes: ''
    }
}];
let currentIndex = 0;
let currentCustomerCode = '';
let isDataLoaded = true;

/* ================== HELPERS ================== */
function findCustomerByCode(code) {
    return excelData.find(item => String(item['Merch Code']) === code);
}

function fillCustomerData(match) {
    accCode.value = match['Acc-Code'] || '';
    custName.value = match['Customer Name'] || '';
    custAddress.value = match['Customer Address'] || '';
    custType.value = match['Customer Type'] || '';
    custGov.value = match['Gov.'] || '';
    notes.value = match['Notes'] || '';
}

function clearCustomerData() {
    accCode.value = '';
    custName.value = '';
    custAddress.value = '';
    custType.value = '';
    custGov.value = '';
    notes.value = '';
    currentCustomerCode = '';
}

function saveCurrentCustomerDataToSlide() {
    slides[currentIndex].customerData = {
        merchCode: merchCode.value || '',
        accCode: accCode.value || '',
        custName: custName.value || '',
        custAddress: custAddress.value || '',
        custType: custType.value || '',
        custGov: custGov.value || '',
        notes: notes.value || ''
    };
}

function renderSlides() {
    slidesList.innerHTML = '';
    slides.forEach((s, i) => {
        const d = document.createElement('div');
        d.textContent = `سلايد ${i+1} - ${s.customerData.custName || 'بدون عميل'}`;
        d.onclick = () => {
            saveCurrentCustomerDataToSlide();
            currentIndex = i;
            loadCustomerDataFromSlide();
            renderSlides();
        };
        slidesList.appendChild(d);
    });
}

function loadCustomerDataFromSlide() {
    const d = slides[currentIndex].customerData;
    merchCode.value = d.merchCode;
    accCode.value = d.accCode;
    custName.value = d.custName;
    custAddress.value = d.custAddress;
    custType.value = d.custType;
    custGov.value = d.custGov;
    notes.value = d.notes;
}

/* ================== ⭐⭐ FIX HERE ⭐⭐ ================== */
merchCode.addEventListener('input', () => {

    if (!isDataLoaded) return;

    const code = merchCode.value.trim();

    if (code === '') {
        clearCustomerData();
        saveCurrentCustomerDataToSlide();
        renderSlides();
        return;
    }

    const match = findCustomerByCode(code);

    if (match) {
        fillCustomerData(match);
        currentCustomerCode = code;

        /* ✅ الحل النهائي */
        saveCurrentCustomerDataToSlide();
        renderSlides();

    } else {
        clearCustomerData();
        saveCurrentCustomerDataToSlide();
        renderSlides();
    }
});

/* ================== INIT ================== */
renderSlides();
</script>

</body>
</html>
