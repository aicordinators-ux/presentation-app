<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مصمم برزنتيشن مع بيانات العملاء</title>
  <script src="https://unpkg.com/pptxgenjs@3.9.0/dist/pptxgen.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{--bg:#f7f7f8;--card:#fff;--accent:#0b71eb;--muted:#666}
    html,body{height:100%;margin:0;font-family:Tahoma, Arial, sans-serif;background:var(--bg);color:#111}
    .app{max-width:980px;margin:12px auto;padding:14px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px}
    button{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:8px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,113,235,.15)}
    main{margin-top:12px}
    .slide-area{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(10,10,10,.04)}
    .placeholders{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .ph{position:relative;padding-top:56.25%;background:linear-gradient(180deg,#eef2ff,#fff);border-radius:8px;border:2px dashed rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer}
    .ph img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .ph .label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px;text-align:center;padding:4px}
    .small{font-size:13px;color:var(--muted);margin-top:10px}
    input[type="text"]{padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px;width:100%}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin-top:10px;margin-bottom:10px}
  </style>
</head>
<body dir="rtl">
  <div class="app">
    <header>
      <h1>مصمم برزنتيشن — بيانات العملاء</h1>
      <div class="controls">
        <button id="addSlideBtn">➕ إضافة سلايد</button>
        <button id="exportBtn">📤 تصدير العرض</button>
      </div>
    </header>

    <section class="form-grid">
      <div><label>Merch Code</label><input type="text" id="merchCode"></div>
      <div><label>Acc-Code</label><input type="text" id="accCode" readonly></div>
      <div><label>Customer Name</label><input type="text" id="custName" readonly></div>
      <div><label>Address</label><input type="text" id="custAddress" readonly></div>
      <div><label>Customer Type</label><input type="text" id="custType" readonly></div>
      <div><label>Gov.</label><input type="text" id="custGov" readonly></div>
      <div><label>Notes</label><input type="text" id="notes"></div>
    </section>

    <main>
      <section class="slide-area">
        <div class="placeholders" id="placeholders"></div>
        <div class="small">اضغط على أي مربع لاختيار صورة من الكاميرا أو المعرض.</div>
      </section>
      <section class="small">قائمة السلايدات:</section>
      <div class="slides-list" id="slidesList"></div>
      <input type="file" id="hiddenFileInput" accept="image/*" style="display:none" />
    </main>

    <footer>
      <div class="small">الصور سيتم ضغطها إلى 600px لتقليل الحجم.</div>
      <div class="right"><button id="clearBtn" class="ghost">🗑️ تفريغ السلايدات</button></div>
    </footer>
  </div>

  <div class="toast" id="toast" style="display:none;position:fixed;bottom:20px;right:20px;background:#0b71eb;color:#fff;padding:10px 14px;border-radius:8px;font-size:14px;"></div>

  <script>
    let excelData = [];
    let slides = [ [null,null,null] ];
    let currentIndex = 0;
    const MAX_WIDTH = 600;
    const placeholdersEl = document.getElementById('placeholders');
    const slidesListEl = document.getElementById('slidesList');
    const hiddenInput = document.getElementById('hiddenFileInput');
    const toast = document.getElementById('toast');
    let pendingIdx = 0;

    function showToast(msg, time=3000){toast.textContent=msg;toast.style.display='block';setTimeout(()=>toast.style.display='none',time);}

    // ✅ تحميل البيانات من Google Sheets
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1N6b3EQdXS4X8fMtHZ04tHkwKTOgNzQyuLVA-V7HZzOk/gviz/tq?tqx=out:json";

    async function loadSheetData() {
      try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));

        excelData = json.table.rows.map(r => ({
          "Merch Code": String(r.c[0]?.v ?? ''),
          "Acc-Code": String(r.c[1]?.v ?? ''),
          "Customer Name": String(r.c[2]?.v ?? ''),
          "Customer Address": String(r.c[3]?.v ?? ''),
          "Customer Type": String(r.c[4]?.v ?? ''),
          "Gov.": String(r.c[5]?.v ?? ''),
          "Notes": String(r.c[6]?.v ?? '')
        }));

        showToast('تم تحميل بيانات Google Sheet بنجاح ✅');
      } catch (err) {
        console.error(err);
        showToast('فشل تحميل بيانات Google Sheet ❌');
      }
    }
    loadSheetData();

    // 🧠 تعبئة البيانات عند كتابة Merch Code
  document.getElementById('merchCode').addEventListener('input', ()=>{
  const code = document.getElementById('merchCode').value.trim();

  // نحاول نعمل مطابقة مرنة بغض النظر عن الأصفار أو النوع
  const match = excelData.find(r => {
    const sheetCode = String(r['Merch Code'] || '').trim();
    return sheetCode === code || sheetCode.replace(/^0+/, '') === code.replace(/^0+/, '');
  });

  if(match){
    document.getElementById('accCode').value = match['Acc-Code'] || '';
    document.getElementById('custName').value = match['Customer Name'] || '';
    document.getElementById('custAddress').value = match['Customer Address'] || '';
    document.getElementById('custType').value = match['Customer Type'] || '';
    document.getElementById('custGov').value = match['Gov.'] || '';
    document.getElementById('notes').value = match['Notes'] || '';
  } else {
    document.querySelectorAll('#accCode,#custName,#custAddress,#custType,#custGov,#notes').forEach(el=>el.value='');
  }
});

    // 📸 اختيار الصورة (كاميرا أو معرض)
    function openImagePicker(idx){
      pendingIdx = idx;
      const overlay = document.createElement('div');
      overlay.style.position='fixed';
      overlay.style.inset=0;
      overlay.style.background='rgba(0,0,0,0.5)';
      overlay.style.display='flex';
      overlay.style.alignItems='center';
      overlay.style.justifyContent='center';
      overlay.style.zIndex='9999';
      overlay.innerHTML = `
        <div style="background:#fff;padding:20px;border-radius:12px;text-align:center;min-width:240px;">
          <h3 style="margin-bottom:10px;">اختر المصدر</h3>
          <button id="camBtn" style="background:#0b71eb;color:#fff;border:none;padding:10px 14px;border-radius:8px;margin:6px;">📷 الكاميرا</button>
          <button id="galleryBtn" style="background:#2c8a2c;color:#fff;border:none;padding:10px 14px;border-radius:8px;margin:6px;">🖼️ المعرض</button>
        </div>`;
      document.body.appendChild(overlay);

      // الكاميرا
      overlay.querySelector('#camBtn').addEventListener('click', ()=>{
        document.body.removeChild(overlay);
        const camInput=document.createElement('input');
        camInput.type='file';
        camInput.accept='image/*;capture=camera';
        camInput.style.display='none';
        camInput.addEventListener('change',async e=>{
          const file=e.target.files&&e.target.files[0];
          if(file) await handleSelectedFile(file);
        });
        document.body.appendChild(camInput);
        camInput.click();
        camInput.addEventListener('blur',()=>setTimeout(()=>camInput.remove(),500));
      });

      // المعرض
      overlay.querySelector('#galleryBtn').addEventListener('click', ()=>{
        document.body.removeChild(overlay);
        hiddenInput.value='';
        hiddenInput.click();
      });

      // إغلاق النافذة عند الضغط بالخارج
      overlay.addEventListener('click', e=>{
        if(e.target===overlay) document.body.removeChild(overlay);
      });
    }

    async function handleSelectedFile(file){
      if(!file) return;
      showToast('جاري معالجة الصورة...');
      const dataUrl = await fileToDataURL(file);
      const resized = await resizeDataUrl(dataUrl, MAX_WIDTH, 0.8);
      slides[currentIndex][pendingIdx] = resized;
      renderCurrentSlide();
      showToast('تم إضافة الصورة ✅');
    }

    function fileToDataURL(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file);});}
    function resizeDataUrl(dataUrl,maxWidth,quality=0.85){return new Promise((res,rej)=>{const img=new Image();img.onload=()=>{const ratio=img.width/img.height;const w=Math.min(maxWidth,img.width);const h=Math.round(w/ratio);const c=document.createElement('canvas');c.width=w;c.height=h;const ctx=c.getContext('2d');ctx.drawImage(img,0,0,w,h);res(c.toDataURL('image/jpeg',quality));};img.onerror=()=>rej(new Error('Image load error'));img.src=dataUrl;});}
    hiddenInput.addEventListener('change',async e=>{const f=e.target.files&&e.target.files[0];await handleSelectedFile(f);});

    function renderSlides(){slidesListEl.innerHTML='';slides.forEach((s,i)=>{const thumb=document.createElement('div');thumb.className='slide-thumb';thumb.textContent='سلايد '+(i+1);thumb.addEventListener('click',()=>{currentIndex=i;renderCurrentSlide();});slidesListEl.appendChild(thumb);});}
    function renderCurrentSlide(){placeholdersEl.innerHTML='';slides[currentIndex].forEach((d,idx)=>{const ph=document.createElement('div');ph.className='ph';if(d){const img=document.createElement('img');img.src=d;ph.appendChild(img);}else{const l=document.createElement('div');l.className='label';l.textContent='اضغط لاختيار صورة';ph.appendChild(l);}ph.addEventListener('click',()=>openImagePicker(idx));placeholdersEl.appendChild(ph);});renderSlides();}
    renderCurrentSlide();

    document.getElementById('addSlideBtn').addEventListener('click',()=>{slides.push([null,null,null]);currentIndex=slides.length-1;renderCurrentSlide();});
    document.getElementById('clearBtn').addEventListener('click',()=>{if(confirm('هل تريد حذف كل السلايدات؟')){slides=[ [null,null,null] ];currentIndex=0;renderCurrentSlide();}});

    // 🎞️ تصدير العرض
    document.getElementById('exportBtn').addEventListener('click', async ()=>{
      const pptx = new PptxGenJS(); pptx.layout='LAYOUT_WIDE';
      const merch = document.getElementById('merchCode').value;
      const acc = document.getElementById('accCode').value;
      const name = document.getElementById('custName').value;
      const addr = document.getElementById('custAddress').value;
      const type = document.getElementById('custType').value;
      const gov = document.getElementById('custGov').value;
      const notes = document.getElementById('notes').value;

      slides.forEach(s=>{
        const slide = pptx.addSlide();
        const imgW=(13.33-(0.6*2)-0.3*2)/3;const imgH=4.5;
        s.forEach((data,j)=>{
          const x=0.6+j*(imgW+0.15);const y=1.0;
          if(data) slide.addImage({data,x,y,w:imgW,h:imgH});
          else {slide.addShape(pptx.ShapeType.rect,{x,y,w:imgW,h:imgH,fill:{color:'F7F7F7'},line:{color:'CCC'}});}
        });
        const rows=[
          [{text:'Merch Code',bold:true},{text:'Acc-Code',bold:true},{text:'Customer Name',bold:true},{text:'Customer Address',bold:true},{text:'Customer Type',bold:true},{text:'Gov.',bold:true},{text:'Notes',bold:true}],
          [merch,acc,name,addr,type,gov,notes]
        ];
        slide.addTable(rows,{x:0.3,y:6,w:12.5,fontSize:13,border:{pt:1,color:'999'},fill:{color:'F9F9F9'}});
      });

      await pptx.writeFile({fileName:'presentation_with_customers.pptx'});
      showToast('تم إنشاء العرض بنجاح ✅');
    });
  </script>
</body>
</html>
